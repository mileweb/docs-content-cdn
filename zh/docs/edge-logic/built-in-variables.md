## 内置变量

下表列出了 CDN Pro 服务器支持的所有内置变量。您可以在边缘逻辑（Edge Logic）或[均衡器逻辑 （Load Balancer Logic）](lb7-es-structure)中使用它们，但请注意并非所有变量都支持配置在这两个地方。[实时日志](/docs/portal/edge-configurations/creating-property#real-time-log)支持与均衡器逻辑完全相同的变量集合。表中的大多数变量都是只读的，只有那些标记为<span class="badge cyan">R/W</span>的变量可写。表中的<span class="badge small" title="numerical value">#</span>标记表明该内置变量的值为数值类型。当您在控制台上编辑边缘逻辑或者实时日志时，如果输入`$`，系统的自动补齐功能将会为您列举出所有当前位置可支持的内置变量。

要正确使用变量，需要了解请求处理的生命周期。NGINX 处理请求时会经历[多个阶段](</docs/edge-logic/declarative-imperative#timing-of-the-declarative-directives>)。在不同的阶段，NGINX 会给变量赋值或动态更新变量的值。如果过早地读取变量可能导致预期外的结果。例如，当请求还未传递到上层服务器之前，不应读取 $upstream_* 这种上游请求相关的变量。例如，$bytes_sent、$body_bytes_sent 和 $sc_completed 等变量仅在响应完成后才可用。在响应完成之前，不应去读取这些变量，即便是add_header指令（构造响应头时执行）也不例外。这几个变量应当仅在日志记录阶段使用，通过 custom_log_field 指令或实时日志读取变量。此外，有些变量（如 $request_time） 在请求生命周期中会被持续地更新。如果在这些变量最终确定之前读取，得到的值将与请求完成时的值不同。

**注意:** 由于边缘节点架构升级，7层负载均衡器逻辑即将被废弃。请避免使用7层负载均衡器逻辑。所有支持的指令和变量应全部在边缘逻辑中配置。更多信息，请查看[该文档](</docs/edge-logic/edge-node-structure-upgrade.md>)。

| **变量名称** | **描述** | **边缘逻辑** | **均衡器逻辑** |
| ---- | ---- | ---- | ---- |
| <span id="arg_"></span><span class="var">$arg_<em>name</em></span> | URL 问号后参数中的指定参数内容 | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="args"></span><span class="var">$args</span> | 请求 URL 中所有问号后参数内容 | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="body_bytes_sent"></span><span class="var">$body_bytes_sent</span> |<span class="badge small" title="numerical value">#</span> 响应给客户端的文件 body 大小 | <span class="badge yellow">No</span> | <span class="badge green">Yes</span> |
| <span id="bytes_sent"></span><span class="var">$bytes_sent</span> |<span class="badge small" title="numerical value">#</span> 响应给客户端的数据大小（包含 header ） | <span class="badge yellow">No</span> | <span class="badge green">Yes</span> |
| <span id="cache_misc"></span><span class="var">$cache_misc</span> | 添加到缓存 key 中的参数 | <span class="badge cyan">R/W</span> | <span class="badge yellow">No</span> |
| <span id="client_country_code"></span><span class="var">$client_country_code</span> | 客户端的国家码（ISO 3166 格式） | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="client_http_version"></span><span class="var">$client_http_version</span> | 客户端请求的 HTTP 协议版本，例如 "HTTP/1.1" | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="client_ip_version"></span><span class="var">$client_ip_version</span> | <span class="badge small" title="numerical value">#</span> 客户端IP 版本：4代表 IPv4 ；6代表 IPv6 | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="client_isp"></span><span class="var">$client_isp</span> | 客户端的 ISP 运营商信息 | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="client_province_code"></span><span class="var">$client_province_code</span> | 客户端的中国省份代码 | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="client_real_ip"></span><span class="var">$client_real_ip</span> | 客户端IP | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="connection_requests"></span><span class="var">$connection_requests</span> |<span class="badge small" title="numerical value">#</span> 本次连接中包含的请求次数 | <span class="badge yellow">No</span> | <span class="badge green">Yes</span> |
| <span id="content_code"></span><span class="var">$content_code</span> | 一个可写的变量，对内容赋予标志代码，用来[在报表中对流量进行分类](/docs/edge-logic/faq#如何在报表中对数据进行分类) | <span class="badge cyan">R/W</span> | <span class="badge cyan">R/W</span> |
| <span id="content_length"></span><span class="var">$content_length</span> |<span class="badge small" title="numerical value">#</span> 请求中 Content-Length 头部的值 | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="content_type"></span><span class="var">$content_type</span> | 请求中 Content-Type 头部的值 | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="cookie_"></span><span class="var">$cookie_<em>name</em></span> | 客户端请求中指定的 cookie 参数值。为了支持名称中包含小数点(.)的cookie，我们允许本变量名中出现该字符。这样在某些场合您会需要使用大括号{}来分隔本变量与紧跟其后的小数点符号。例如：$cookie_abc.test 和 ${cookie_abc.test} 都返回 abc.test 这个cookie的值，但是 ${cookie_abc}.test 将返回 abc 这个cookie的值外加“.test” 这个字符串 | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="dollar_sign"></span><span class="var">$dollar_sign</span> | 代表 “$” 字段 | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="download_time"></span><span class="var">$download_time</span> |<span class="badge small" title="numerical value">#</span> CDN Pro从接收到客户请求到将响应正文发送到操作系统buffer的时间，其值为$request_end_time/$turn_around_time/$transfer_time 的总和，单位为秒。同时支持毫秒单位的变量download_times_ms。 $download_time的含义与另一个变量$request_time相同。 | <span class="badge yellow">No</span> | <span class="badge green">Yes</span> |
| <span id="error_code"></span><span class="var">$error_code</span> | 记录客户端与CDN，以及CDN与源站之间的异常信息 | <span class="badge yellow">No</span> | <span class="badge green">Yes</span> |
| <span id="extra_deliver_time_ms"></span><span class="var">$extra_deliver_time_ms</span> |<span class="badge small" title="numerical value">#</span> CDN Pro 将发送缓冲区的剩余数据传输完的大致时间，单位为毫秒 | <span class="badge yellow">No</span> | <span class="badge green">Yes</span> |
| <span id="host"></span><span class="var">$host</span> | 请求的 host 头部，和 $http_host 有相同含义 | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="hostname"></span><span class="var">$hostname</span> | CDN 服务器别名 | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="http_"></span><span class="var">$http_<em>name</em></span> | 客户端请求中指定的请求头参数值 | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="http_host"></span><span class="var">$http_host</span> | 请求的 host 头部，和 $host 有相同含义 | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="ignored_body_in_cache_key"></span><span class="var">$ignored_body_in_cache_key</span> | 空字符串，当 [`proxy_request_body_in_cache_key`](/docs/edge-logic/supported-directives#proxy_request_body_in_cache_key) 被设为 `off`, 或者 '0' 当请求正文的哈希值被加到了缓存key, 否则值为 '1'。| <span class="badge green">Yes</span> | <span class="badge yellow">No</span> |
| <span id="invalid_referer"></span><span class="var">$invalid_referer</span> | 用于标记请求 Referer 的合法性，如“ Referer ”被判定为合法则值为空 ; 否则值为 “1” | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="is_args"></span><span class="var">$is_args</span> | 当客户端请求携带问号后参数时，值为 "?" ；否则值为空 | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="msec"></span><span class="var">$msec</span> |<span class="badge small" title="numerical value">#</span> 当前 Unix 时间戳，以秒为单位，精度到毫秒 | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="sec"></span><span class="var">$sec</span> |<span class="badge small" title="numerical value">#</span> 当前 Unix 时间戳，精度到秒 | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="origin_host"></span><span class="var">$origin_host</span> | 回源时携带的 host 头部值 | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="origin_ip"></span><span class="var">$origin_ip</span> | 源站 IP 和端口，格式为 IP:端口号 | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="origin_status_code"></span><span class="var">$origin_status_code</span> | 回源状态码 | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="pid"></span><span class="var">$pid</span> | CDN 进程 ID 号 | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="pipe"></span><span class="var">$pipe</span> | 如果请求属于“流水线”（pipelined），值为“p”，否则为“.” | <span class="badge yellow">No</span> | <span class="badge green">Yes</span> |
| <span id="property_ver"></span><span class="var">$property_ver</span> |<span class="badge small" title="numerical value">#</span> 加速项版本号 | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="qtl_cpu_cycle"></span><span class="var">$qtl_cpu_cycle</span> |<span class="badge small" title="numerical value">#</span> LB7里全部，以及ES里传输响应正文之前的CPU时间，单位为纳秒（1e-9s) | <span class="badge yellow">No</span> | <span class="badge green">Yes</span> |
| <span id="qtl_req_id"></span><span class="var">$qtl_req_id</span> | 请求的唯一标识 ID | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="qtl_upstream_cache_status"></span><span class="var">$qtl_upstream_cache_status</span> | [缓存状态](https://www.nginx.com/blog/nginx-caching-guide/#Frequently-Asked-Questions-(FAQ)): HIT, MISS, BYPASS, EXPIRED, STALE, UPDATING, REVALIDATED. | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="random_N"></span><span class="var">$random_N</span> |<span class="badge small" title="numerical value">#</span> 一个[0, N-1]之内均匀分布的随机整数，N范围是[2,1e9]。| <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="realtime_log_ds_factor"></span><span class="var">$realtime_log_ds_factor</span> |<span class="badge small" title="numerical value">#</span> 实时日志采样参数，值为 N 代表每N个请求会生产1条实时日志。可以通过设置“[realtime_log_downsample](/docs/edge-logic/supported-directives#realtime_log_downsample)"指令来取代默认采样率。| <span class="badge green">Yes</span> | <span class="badge yellow">No</span> |
| <span id="realtime_log_ds_ratio"></span><span class="var">$realtime_log_ds_ratio</span> |<span class="badge small" title="numerical value">#</span> 实时日志采样率， $realtime_log_ds_factor 的倒数，值为介于0~1之间的小数。 | <span class="badge green">Yes</span> | <span class="badge yellow">No</span> |
| <span id="remote_user"></span><span class="var">$remote_user</span> | 当使用[基础鉴权](https://datatracker.ietf.org/doc/html/rfc7617)时，从Authorization请求头中提取的用户名 | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="request"></span><span class="var">$request</span> | 完整的 http 请求行 | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="request_cpu_time"></span><span class="var">$request_cpu_time</span> |<span class="badge small" title="numerical value">#</span> 处理该请求时所消耗的CPU时间, 在Edge Logic 中被使用时仅包含 ES 层的执行消耗，当在 LB Logic 或实时日志中被使用时仅包含负载均衡层的总执行消耗。单位为纳秒。| <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="request_start_time"></span><span class="var">$request_start_time</span> |<span class="badge small" title="numerical value">#</span> CDN Pro接收到客户请求第一个字节的 Unix 时间戳，以秒为单位，精度到毫秒 | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="request_end_time"></span><span class="var">$request_end_time</span> |<span class="badge small" title="numerical value">#</span> 接收来自客户端的请求头并准备好处理/转发它所需的时间，单位为秒。同时支持毫秒单位的变量 request_end_time_ms。  | <span class="badge yellow">No</span> | <span class="badge green">Yes</span> |
| <span id="request_length"></span><span class="var">$request_length</span> |<span class="badge small" title="numerical value">#</span> 请求的长度 (包括请求的地址, http 请求头和请求主体) | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="request_method"></span><span class="var">$request_method</span> | HTTP 请求方法，例如 ：GET, POST | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="request_scheme"></span><span class="var">$request_scheme</span> | 请求协议，值为"http" 或者 "https" | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="request_time"></span><span class="var">$request_time</span> |<span class="badge small" title="numerical value">#</span> 以毫秒为单位的请求处理时间，标记服务端从客户端读取第一个字节到发送最后一个字节给客户端所经过的时间。该时间等于$request_end_time，$turn_around_time和$transfer_time这3个变量的值之和。对于小请求，请求和响应通常各自一次发包完成。这种情况下，$request_end_time和$transfer_time的值为0，$request_time的值与$turn_around_time相同。 | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="request_uri"></span><span class="var">$request_uri</span> | 从'/'开始，包含问号后参数的客户端请求 URI | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="sc_completed"></span><span class="var">$sc_completed</span> |<span class="badge small" title="numerical value">#</span> 如果本次请求的所有数据都已响应给客户端则值为1，否则值为0  | <span class="badge yellow">No</span> | <span class="badge green">Yes</span> |
| <span id="sc_initial"></span><span class="var">$sc_initial</span> |<span class="badge small" title="numerical value">#</span> 如果本次请求的第一个字节已响应给客户端则值为1，否则值为0| <span class="badge yellow">No</span> | <span class="badge green">Yes</span> |
| <span id="sent_http_"></span><span class="var">$sent\_http\_<em>name</em></span> | 响应给客户端的指定参数值 | <span class="badge yellow">No</span> | <span class="badge green">Yes</span> |
| <span id="sent_http_content_length"></span><span class="var">$sent_http_content_length</span> |<span class="badge small" title="numerical value">#</span> 响应给客户端的Content-Length 头部值 | <span class="badge yellow">No</span> | <span class="badge green">Yes</span> |
| <span id="served_from_cache"></span><span class="var">$served_from_cache</span> |<span class="badge small" title="numerical value">#</span> 如该请求在边缘的命中状态是 HIT ，则值是1；否则值为0 | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="server_addr"></span><span class="var">$server_addr</span> | 边缘服务器的 IP 地址 | <span class="badge yellow">No</span> | <span class="badge green">Yes</span> |
| <span id="server_level"></span><span class="var">$server_level</span> | <span class="badge small" title="numerical value">#</span> 缓存服务器的层级。1代表边缘缓存，2代表父级缓存 | <span class="badge yellow">No</span> | <span class="badge green">Yes</span> |
| <span id="server_name"></span><span class="var">$server_name</span> | 加速项配置里匹配用户请求的加速域名 | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="server_region"></span><span class="var">$server_region</span> | 边缘服务器的国家代码，例如CN，US | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="server_province_code"></span><span class="var">$server_province_code</span> | 边缘服务器的中国城市代码 | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="server_protocol"></span><span class="var">$server_protocol</span> | HTTP/1.1 or HTTP/2.0 | <span class="badge yellow">No</span> | <span class="badge green">Yes</span> |
| <span id="service_port"></span><span class="var">$service_port</span> |<span class="badge small" title="numerical value">#</span> 接收请求的 CDN 边缘节点端口号 | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="sorted_querystring_args"></span><span class="var">$sorted_querystring_args</span> | 该变量以 ASCII 格式输出排序后的请求URL中的问号后参数内容，它可以通过该指令进行修改 "[sorted_querystring_filter_parameter](/docs/edge-logic/supported-directives#sorted_querystring_filter_parameter)" | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="ssl_cipher"></span><span class="var">$ssl_cipher</span> | 本次 SSL 请求中所使用的 TLS 加密套件 | <span class="badge yellow">No</span> | <span class="badge green">Yes</span> |
| <span id="request_ssl_handshake_time"></span><span class="var">$request_ssl_handshake_time</span> |<span class="badge small" title="numerical value">#</span> 处理该请求时，在 ssl 握手阶段所消耗的CPU时间，单位为纳秒 | <span class="badge yellow">No</span> | <span class="badge green">Yes</span> |
| <span id="ssl_protocol"></span><span class="var">$ssl_protocol</span> | SSL 握手协议， 例如"TLSv1.1" | <span class="badge yellow">No</span> | <span class="badge green">Yes</span> |
| <span id="ssl_server_name"></span><span class="var">$ssl_server_name</span> | TLS 中 SNI 携带的 servername | <span class="badge yellow">No</span> | <span class="badge green">Yes</span> |
| <span id="status"></span><span class="var">$status</span> | 响应给客户端的 HTTP 状态码 | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="tcpinfo_delivery_rate"></span><span class="var">$tcpinfo_delivery_rate</span> |<span class="badge small" title="numerical value">#</span> 客户端接收数据的速率，单位为 bytes/s | <span class="badge yellow">No</span> | <span class="badge green">Yes</span> |
| <span id="tcpinfo_min_rtt"></span><span class="var">$tcpinfo_min_rtt</span> |<span class="badge small" title="numerical value">#</span> 本次请求中由 tcp 协议栈统计到的最小 RTT , 单位为微秒 | <span class="badge yellow">No</span> | <span class="badge green">Yes</span> |
| <span id="tcpinfo_rtt"></span><span class="var">$tcpinfo_rtt</span> |<span class="badge small" title="numerical value">#</span> 本次请求中由 tcp 协议栈统计到的最后一次 RTT , 单位为微秒 | <span class="badge yellow">No</span> | <span class="badge green">Yes</span> |
| <span id="time_http"></span><span class="var">$time_http</span> | RFC 7231 格式下的当前系统时间，可用于响应中的 Date 头部值 | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="transfer_time"></span><span class="var">$transfer_time</span> |<span class="badge small" title="numerical value">#</span> CDN Pro 将完整的响应正文（直到最后一个字节）发送到系统缓冲区所需的时间，单位为秒。同时支持毫秒单位的变量transfer_time_ms。| <span class="badge yellow">No</span> | <span class="badge green">Yes</span> |
| <span id="turn_around_time"></span><span class="var">$turn_around_time</span> |<span class="badge small" title="numerical value">#</span> CDN Pro 从发出回源请求到接收源站响应的第一个字节所需的时间，单位为秒。同时支持毫秒单位的变量turn_around_time_ms。  | <span class="badge yellow">No</span> | <span class="badge green">Yes</span> |
| <span id="upstream_bytes_received"></span><span class="var">$upstream_bytes_received</span> |<span class="badge small" title="numerical value">#</span> 从中间层节点或者源站收到的回上层数据大小，单位为 bytes | <span class="badge green">Yes</span> | <span class="badge yellow">No</span> |
| <span id="upstream_bytes_sent"></span><span class="var">$upstream_bytes_sent</span> |<span class="badge small" title="numerical value">#</span> 向中间层节点或者源站发送的请求数据大小，单位为 bytes | <span class="badge green">Yes</span> | <span class="badge yellow">No</span> |
| <span id="upstream_connect_time"></span><span class="var">$upstream_connect_time</span> |<span class="badge small" title="numerical value">#</span> 向中间层或者源站发起请求时的建联时间，单位为毫秒 | <span class="badge green">Yes</span> | <span class="badge yellow">No</span> |
| <span id="upstream_cookie_"></span><span class="var">$upstream\_cookie\_<em>name</em></span> | 从中间层或者源站拿到的 cookie 值，通常该值会以" Set-Cookie "的形式传递，可能源自中间层的HIT已缓存数据。为了支持名称中包含小数点(.)的cookie，我们允许本变量名中出现该字符。这样在某些场合您会需要使用大括号{}来分隔本变量与紧跟其后的小数点符号。例如：$upstream_cookie_abc.test 和 ${upstream_cookie_abc.test} 都返回 abc.test 这个cookie的值，但是 ${upstream_cookie_abc}.test 将返回 abc 这个cookie的值外加“.test” 这个字符串 | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="upstream_header_time"></span><span class="var">$upstream_header_time</span> |<span class="badge small" title="numerical value">#</span> 从中间层或者源站请求数据时，接收响应 header 过程消耗的时间，单位为毫秒 | <span class="badge green">Yes</span> | <span class="badge yellow">No</span> |
| <span id="upstream_http_"></span><span class="var">$upstream\_http\_<em>name</em></span> | 从中间层或者源站拿到的响应头，可能源自中间层的 HIT 已缓存数据 | <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
| <span id="upstream_response_status"></span><span class="var">$upstream_response_status</span> | 从中间层或者源站拿到的响应状态码，如本请求没有发起回源则该变量值为0 | <span class="badge green">Yes</span> | <span class="badge yellow">No</span> |
| <span id="upstream_response_time"></span><span class="var">$upstream_response_time</span> |<span class="badge small" title="numerical value">#</span> 从中间层或者源站获取完整响应数据所消耗的时间，单位为毫秒 | <span class="badge green">Yes</span> | <span class="badge yellow">No</span> |
| <span id="upstream_server_type"></span><span class="var">$upstream_server_type</span> | 'O' 代表回源站; 'C' 代表回中间层节点. | <span class="badge green">Yes</span> | <span class="badge yellow">No</span> |
| <span id="upstream_trailer_"></span><span class="var">$upstream\_trailer\_<em>name</em></span> | 由上层添加的尾部（trailer） 值。通常该值会通过上层的[add_trailer](/docs/edge-logic/supported-directives#add_trailer) 指令设置 | <span class="badge yellow">No</span> | <span class="badge green">Yes</span> |
| <span id="uri"></span><span class="var">$uri</span> | [归一化的](http://nginx.org/en/docs/http/ngx_http_core_module.html#location)请求 uri ，从'/'开始且不包含 query string 。其值会被边缘逻辑里的"[rewrite](/docs/edge-logic/supported-directives#rewrite)"指令修改。| <span class="badge green">Yes</span> | <span class="badge green">Yes</span> |
